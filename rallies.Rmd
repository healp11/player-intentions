---
title: "rallies"
author: "Pat Healy"
date: "17 November 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(devtools)
library(ggplot2)
library(tidyr)
library(dplyr)
library(tidyverse)
```
```{r}
load("data/rallies.RData")
library(readr)
```
Shaping data to recreate the variables used in ("Federer AO 2017.Rmd")'Federer vs Berych 2017' for the AO matches 'Djokovic v Chung 2016', 'Djokovic v Chung 2018', 'Federer v Berdych 2016', 'Federer v Berdych 2018', 'Makarova v Konta 2016','Makarova v Konta 2017','Strycova v Garcia 2016' 'Strycova v Garcia 2017', 'Siegemund v Jankovic 2016','Siegemund v Jankovic 2017', 'Goffin v Thiem 2016''Goffin v Thiem 2017'""

'Siegemund v Jankovic 2017' goes from set 3 to set 6?? 

#### Sorting the matches

```{r df}
djo16_df <- filter(rallies, year == 2016, h2h == "DJOKOVIC CHUNG" )
djo16_df <- arrange(djo16_df, matchid, set, game, point, shot)

djo18_df <- filter(rallies, year == 2018, h2h == "DJOKOVIC CHUNG" )
djo18_df <- arrange(djo18_df, matchid, set, game, point, shot)

fed16_df <- filter(rallies, year == 2016, h2h == "FEDERER BERDYCH" )
fed16_df <- arrange(fed16_df, matchid, set, game, point, shot)

fed17_df <- filter(rallies, year == 2017, h2h == "FEDERER BERDYCH" )
fed17_df <- arrange(fed17_df, matchid, set, game, point, shot)

fed18_df <- filter(rallies, year == 2018, h2h == "FEDERER BERDYCH" )
fed18_df <- arrange(fed18_df, matchid, set, game, point, shot)

mak16_df <- filter(rallies, year == 2016, h2h == "MAKAROVA KONTA" )
mak16_df <- arrange(mak16_df, matchid, set, game, point, shot)

mak17_df <- filter(rallies, year == 2017, h2h == "MAKAROVA KONTA" )
mak17_df <- arrange(mak17_df, matchid, set, game, point, shot)

stry16_df <- filter(rallies, year == 2016, h2h == "STRYCOVA GARCIA" )
stry16_df <- arrange(stry16_df, matchid, set, game, point, shot)

stry17_df <- filter(rallies, year == 2017, h2h == "STRYCOVA GARCIA" )
stry17_df <- arrange(stry17_df, matchid, set, game, point, shot)

sie16_df <- filter(rallies, year == 2016, h2h == "SIEGEMUND JANKOVIC" )
sie16_df <- arrange(sie16_df, matchid, set, game, point, shot)

sie17_df <- filter(rallies, year == 2017, h2h == "SIEGEMUND JANKOVIC" )
sie17_df <- arrange(sie17_df, matchid, set, game, point, shot)

thi16_df <- filter(rallies, year == 2016, h2h == "THIEM GOFFIN" )
thi16_df <- arrange(thi16_df, matchid, set, game, point, shot)

thi17_df <- filter(rallies, year == 2017, h2h == "THIEM GOFFIN" )
thi17_df <- arrange(thi17_df, matchid, set, game, point, shot)
```

Starting with fed16 to compare to fed17



```{r df temporarily removing inversion of y axis}

#Reorienting shots so that all Federer's shot are from negative x side of court, and all opponents shots are from positive x side. y coordinates have been flipped as required.
fed16_df <- fed16_df %>% rowwise %>%
  mutate(projected.ballmark.x = ifelse(impact.player == "FEDERER" & start.x >= 0, -projected.ballmark.x, projected.ballmark.x)) %>%
  #mutate(projected.ballmark.y = ifelse(impact.player == "FEDERER" & start.x >= 0, -projected.ballmark.y, projected.ballmark.y)) %>%
  #mutate(start.y = ifelse(impact.player == "FEDERER" & start.x >= 0, -start.y, start.y))%>%
  mutate(start.x = ifelse(impact.player == "FEDERER" & start.x >= 0, -start.x, start.x)) 

#Reorienting opponent shots
fed16_df <- fed16_df %>% rowwise %>%
  #mutate(start.y = ifelse(impact.player != "FEDERER" & start.x <= 0, -start.y, start.y)) %>%
  mutate(projected.ballmark.x = ifelse(impact.player != "FEDERER" & start.x <= 0, -projected.ballmark.x, projected.ballmark.x)) %>%
  #mutate(projected.ballmark.y = ifelse(impact.player != "FEDERER" & start.x <= 0, -projected.ballmark.y, projected.ballmark.y)) %>%
  mutate(start.x = ifelse(impact.player != "FEDERER" & start.x <= 0, -start.x, start.x))
```


```{r temporarily removing inversion of y axis}
#Reorienting player positions so that all Federer's & Opponents start/end positions match reoriented ballmarks
#For Federer
fed16_df <- fed16_df %>% rowwise %>%
  mutate(start.server.x = ifelse(server == "FEDERER" & start.server.x >= 0, -start.server.x, start.server.x)) %>%
  #mutate(start.server.y = ifelse(server == "FEDERER" & start.server.x >= 0, -start.server.y, start.server.y)) %>%
  #mutate(start.receiver.y = ifelse(receiver.score == "FEDERER" & start.receiver.x >= 0, -start.receiver.y, start.receiver.y))%>%
  mutate(start.receiver.x = ifelse(receiver == "FEDERER" & start.receiver.x >= 0, -start.receiver.x, start.receiver.x)) 

fed16_df <- fed16_df %>% rowwise %>%
  mutate(end.server.x = ifelse(server == "FEDERER" & end.server.x >= 0, -end.server.x, end.server.x)) %>%
  #mutate(end.server.y = ifelse(server == "FEDERER" & end.server.x >= 0, -end.server.y, end.server.y)) %>%
  #mutate(end.receiver.y = ifelse(receiver == "FEDERER" & end.receiver.x >= 0, -end.receiver.y, end.receiver.y))%>%
  mutate(end.receiver.x = ifelse(receiver == "FEDERER" & end.receiver.x >= 0, -end.receiver.x, end.receiver.x)) 
```
```{r temporarily removing inversion of y axis}
#For Opponent
fed16_df <- fed16_df %>% rowwise %>%
  mutate(start.server.x = ifelse(server != "FEDERER" & start.server.x <= 0, -start.server.x, start.server.x)) %>%
  #mutate(start.server.y = ifelse(server != "FEDERER" & start.server.x <= 0, -start.server.y, start.server.y)) %>%
  #mutate(start.receiver.y = ifelse(receiver.score != "FEDERER" & start.receiver.x <= 0, -start.receiver.y, start.receiver.y))%>%
  mutate(start.receiver.x = ifelse(receiver != "FEDERER" & start.receiver.x <= 0, -start.receiver.x, start.receiver.x)) 

fed16_df <- fed16_df %>% rowwise %>%
  mutate(end.server.x = ifelse(server != "FEDERER" & end.server.x <= 0, -end.server.x, end.server.x)) %>%
  #mutate(end.server.y = ifelse(server != "FEDERER" & end.server.x <= 0, -end.server.y, end.server.y)) %>%
  #mutate(end.receiver.y = ifelse(receiver != "FEDERER" & end.receiver.x <= 0, -end.receiver.y, end.receiver.y))%>%
  mutate(end.receiver.x = ifelse(receiver != "FEDERER" & end.receiver.x <= 0, -end.receiver.x, end.receiver.x)) 
```



#####Recreating variables from Federer AO 2017 for fed16. 
(some columns in rallies data have a different classification than in federer2017 data. Such as 'is.good' replaces 'ended.in.error')(With Aces dropped we also now cannot recreate retser, retser1 or retser2 )

```{r}
fed16_df <- fed16_df %>%
  mutate(lastshot = ifelse(shot == final.shot,1,0)) %>%
  mutate(isserver = ifelse(server == impact.player,1,0)) %>%
  mutate(fhand = ifelse(hitpoint == "F",1,0)) %>%
  mutate(opponent = ifelse(server == "FEDERER", receiver, server)) 
 

  

```

```{r}
#use group_index
#Want to create an index want to group by when the rally starts
#How to create an inde on multiple rows
#to assign an index add a new column that has 1 to n() row of a data set
#Want to group by everything exccept shot number/ final shot number

#changes of angles, have to show the absolute change in angles for every change in direction between shots
#Be very clear about what the angle reference of the baseline and centre line
#Have different columns for 1st second change in direction angle
#make sure that everything that can be looked at in code is being looked at. 

#Broom a package for forecasting and fitting for a model

#Need to look at lecture 6 for fitting data
fed16_df <- fed16_df %>%
  mutate(winner = ifelse(is.good == TRUE & lastshot == 1,1,0)) %>%
  mutate(ser1 = ifelse(serve == 1 & serve_classification == 1,1,0)) %>%
  mutate(ser2 = ifelse(serve == 2 & serve_classification == 1,1,0)) 
  
for (i in 1:ncol(fed16_df)) {
  if(is.character(fed16_df[,i]) == TRUE) {
    fed16_df[,i] <- as.factor(fed16_df[,i])
  }
}
```


```{r}
#Put score differentials in when new data received
```

```{r}
col = c("set","game", "point")
rally.num = as.data.frame(group_indices_(fed16_df,.dots = col))
colnames(rally.num)<- "rally.number"
```

```{r}


fed16_df <- fed16_df %>%
  cbind(rally.num)
 
```



```{r}
#New Variables for player and opponent: start/end positions,  speed &acceleration, distance run within shot, work, advantage, total changes  

#start/end player positions x/y
fed16_df <- fed16_df %>%
  mutate(oppo.start.position.x = ifelse(server != "FEDERER", start.server.x,0)+ifelse(server == "FEDERER", start.receiver.x,0))%>%
  mutate(oppo.start.position.y = ifelse(server != "FEDERER", start.server.y,0)+ifelse(server == "FEDERER", start.receiver.y,0)) %>%
  mutate(oppo.end.position.x = ifelse(server != "FEDERER", end.server.x,0)+ifelse(server == "FEDERER", end.receiver.x,0)) %>%
  mutate(oppo.end.position.y = ifelse(server != "FEDERER", end.server.y,0)+ifelse(server == "FEDERER", end.receiver.y,0)) %>%
  mutate(p.start.position.x = ifelse(server == "FEDERER", start.server.x,0)+ifelse(server != "FEDERER", start.receiver.x,0)) %>%
  mutate(p.start.position.y = ifelse(server == "FEDERER", start.server.y,0)+ifelse(server != "FEDERER", start.receiver.y,0)) %>%
  mutate(p.end.position.x = ifelse(server == "FEDERER", end.server.x,0)+ifelse(server != "FEDERER", end.receiver.x,0)) %>%
  mutate(p.end.position.y = ifelse(server == "FEDERER", end.server.y,0)+ifelse(server != "FEDERER", end.receiver.y,0)) 
  
#player and opponent distances travelled from start of shot to end of next shot
fed16_df <- fed16_df %>%  
  mutate(oppo.distance = ifelse(server != "FEDERER", server.distance,0)+ifelse(server == "FEDERER", receiver.distance,0)) %>%
  mutate(p.distance = ifelse(server == "FEDERER", server.distance,0)+ifelse(server != "FEDERER", receiver.distance,0))

#player and opponent speed 
fed16_df <- fed16_df %>%
  mutate(p.peak.speed = ifelse(server == "FEDERER", server.peak.speed,0)+ifelse(server != "FEDERER", receiver.peak.speed,0)) %>%
  mutate(p.avg.speed = ifelse(server == "FEDERER", server.avg.speed,0)+ifelse(server != "FEDERER", receiver.avg.speed,0)) 
  

#player and opponent acceleration
fed16_df <- fed16_df %>%  
  mutate(p.avg.acceleration = ifelse(server == "FEDERER", server.avg.acceleration,0)+ifelse(server != "FEDERER", receiver.avg.acceleration,0)) %>%
  mutate(p.peak.acceleration = ifelse(server == "FEDERER", server.peak.acceleration,0)+ifelse(server != "FEDERER", receiver.peak.acceleration,0)) %>%
  mutate(oppo.peak.speed = ifelse(server != "FEDERER", server.peak.speed,0)+ifelse(server == "FEDERER", receiver.peak.speed,0)) %>%
  mutate(oppo.avg.speed = ifelse(server != "FEDERER", server.avg.speed,0)+ifelse(server == "FEDERER", receiver.avg.speed,0)) %>%
  mutate(oppo.avg.acceleration = ifelse(server != "FEDERER", server.avg.acceleration,0)+ifelse(server == "FEDERER", receiver.avg.acceleration,0)) %>%
  mutate(oppo.peak.acceleration = ifelse(server != "FEDERER", server.peak.acceleration,0)+ifelse(server == "FEDERER", receiver.peak.acceleration,0))


#player and opponent work
fed16_df <- fed16_df %>%
  mutate(oppo.work = ifelse(server != "FEDERER", server.work,0)+ifelse(server == "FEDERER", receiver.work,0)) %>%
  mutate(p.work = ifelse(server == "FEDERER", server.work,0)+ifelse(server != "FEDERER", receiver.work,0))

#player and opponent advantage
fed16_df <- fed16_df %>%
  mutate(oppo.advantage =ifelse(server != "FEDERER", server.advantage,0)+ifelse(server == "FEDERER", receiver.advantage,0))%>%
   mutate(p.advantage =ifelse(server == "FEDERER", server.advantage,0)+ifelse(server != "FEDERER", receiver.advantage,0))


#player and opponent total changes
fed16_df <- fed16_df %>%
  mutate(oppo.total.changes =ifelse(server != "FEDERER", server.total.changes,0)+ifelse(server == "FEDERER", receiver.total.changes,0))%>%
   mutate(p.total.changes =ifelse(server == "FEDERER", server.total.changes,0)+ifelse(server != "FEDERER", receiver.total.changes,0))
  
  
```

```{r}

#player speed and acceleration differences and ratios
fed16_df <- fed16_df %>%
  mutate(avg.player.speed.diff = p.avg.speed-oppo.avg.speed) %>%
  mutate(peak.player.speed.diff = p.peak.speed-oppo.peak.speed) %>%
  mutate(avg.player.speed.ratio = p.avg.speed/oppo.avg.speed) %>%
  mutate(peak.player.speed.ratio = p.peak.speed/oppo.peak.speed) %>%
  mutate(avg.player.acceleration.diff = (p.avg.acceleration)-(oppo.avg.acceleration)) %>%
  mutate(peak.player.acceleration.diff = (p.peak.acceleration)-(oppo.peak.acceleration)) %>%
  mutate(avg.player.acceleration.ratio = (p.avg.acceleration)/(oppo.avg.acceleration)) %>%
  mutate(peak.player.acceleration.ratio = (p.peak.acceleration)/(oppo.peak.acceleration))

#player/opponent side distance for start/end positions
fed16_df <- fed16_df %>%
  mutate(p.start.position.side.dist = 4.115 - abs(p.start.position.y)) %>%
  mutate(p.end.position.side.dist = 4.115 - abs(p.end.position.y)) %>%
  mutate(oppo.start.position.side.dist = 4.115 - abs(oppo.start.position.y)) %>%
  mutate(oppo.end.position.side.dist = 4.115 - abs(oppo.end.position.y))
  
#player/opponent base distances for start/end positions  
fed16_df <- fed16_df %>%
  mutate(p.start.position.base.dist = 11.89 - abs(p.start.position.x)) %>%
  mutate(p.end.position.base.dist = 11.89 - abs(p.end.position.x)) %>%
  mutate(oppo.start.position.base.dist = 11.89 - abs(oppo.start.position.x)) %>%
  mutate(oppo.end.position.base.dist = 11.89 - abs(oppo.end.position.x))
  
```
```{r}
#player/ opponent shortest distances for start/end positions 
fed16_df <- fed16_df %>%
  mutate(oppo.start.position.short.dist = min(oppo.start.position.side.dist, oppo.start.position.base.dist)) %>%
   mutate(oppo.end.position.short.dist = min(oppo.end.position.side.dist, oppo.end.position.base.dist)) %>%
  mutate(p.start.position.short.dist = min(p.start.position.side.dist, p.start.position.base.dist)) %>%
   mutate(p.end.position.short.dist = min(p.end.position.side.dist, p.end.position.base.dist)) 
```



```{r}

#Tally of the number of times player and opponent change side during rally
fed16_df <- fed16_df %>%
  mutate(p.side.change.count = ifelse(p.start.position.y <= 0 & p.end.position.y >= 0, 1, ifelse(p.start.position.y >= 0 & p.end.position.y <= 0, 1, 0))) %>%
  mutate(p.side.change.cumsum = cumsum(p.side.change.count)) %>%
  mutate(oppo.side.change.count = ifelse(oppo.start.position.y <= 0 & oppo.end.position.y >= 0, 1, ifelse(oppo.start.position.y >= 0 & oppo.end.position.y <= 0, 1, 0))) %>%
  mutate(oppo.side.change.cumsum = cumsum(oppo.side.change.count)) 
  
  
  
  
```
```{r}
fed16_df <- fed16_df %>%
  group_by(rally.number ) %>%
  dplyr::mutate(p.rally.side.change.count = cumsum(p.side.change.count)) %>%
  dplyr::mutate(oppo.rally.side.change.count = cumsum(oppo.side.change.count)) %>%
  ungroup
 
```


```{r}
#Adding angles for player & opposition movement from start position[i] to end position[i] as well as end position[i] to start position[i+1]. Measuring the angle of movement from the baseline. With the baseline running 90 to 270 degrees and the centre service line running 0 to 180 degrees


fed16_df <- fed16_df %>%
  mutate(p.movement.angle.1 = NA) %>%
  mutate(p.movement.angle.2 = NA) %>%
  mutate(oppo.movement.angle.1 = NA) %>%
  mutate(oppo.movement.angle.2 = NA) 
  
  
#player start to end movement angle  
for (i in 1:nrow(fed16_df)) {
  a1 <- fed16_df$p.start.position.x[i]
  b1 <- fed16_df$p.start.position.y[i]
  a2 <- fed16_df$p.end.position.x[i]
  b2 <- fed16_df$p.end.position.y[i]
  
  
  p.movement.angle.1 <- atan(
  ((abs(a1)-abs(a2))/(abs(b1)-abs(b2)))* 180/pi) 
  
  fed16_df$p.movement.angle.1[i] = ifelse(p.movement.angle.1 < 0 & (abs(a1)-abs(a2))<0, 180+p.movement.angle.1,
                                          ifelse(p.movement.angle.1 < 0 & (abs(b1)-abs(b2))<0,360+p.movement.angle.1,
                                                 ifelse(p.movement.angle.1 > 0 & (abs(a1)-abs(a2))<0, 180+p.movement.angle.1,p.movement.angle.1)))
                                                                                                            
}



```
```{r}
#player end position(i) to start position (i+1) movement angle
for (i in 2:nrow(fed16_df)) {
  a1 <- fed16_df$p.end.position.x[i]
  b1 <- fed16_df$p.end.position.y[i]
  a2 <- fed16_df$p.start.position.x[i+1]
  b2 <- fed16_df$p.start.position.y[i+1]
  
  p.movement.angle.2 <- atan(
  ((abs(a1)-abs(a2))/(abs(b1)-abs(b2)))* 180/pi) 
  
  fed16_df$p.movement.angle.2[i] = ifelse(p.movement.angle.2 < 0 & (abs(a1)-abs(a2))<0, 180+p.movement.angle.2,
                                          ifelse(p.movement.angle.2 < 0 & (abs(b1)-abs(b2))<0,360+p.movement.angle.2,
                                                 ifelse(p.movement.angle.2 > 0 & (abs(a1)-abs(a2))<0, 180+p.movement.angle.2,p.movement.angle.2)))
  
}  
  


```

```{r}
# opposition start to end movement angle

  
for (i in 1:nrow(fed16_df)) {
  a1 <- fed16_df$oppo.start.position.x[i]
  b1 <- fed16_df$oppo.start.position.y[i]
  a2 <- fed16_df$oppo.end.position.x[i]
  b2 <- fed16_df$oppo.end.position.y[i]
  
  oppo.movement.angle.1 <- atan(
  ((abs(a1)-abs(a2))/(abs(b1)-abs(b2)))* 180/pi) 
  
  fed16_df$oppo.movement.angle.1[i] = ifelse(oppo.movement.angle.1 < 0 & (abs(a1)-abs(a2))<0,180+oppo.movement.angle.1,
                                          ifelse(oppo.movement.angle.1 < 0 & (abs(b1)-abs(b2))<0,360+oppo.movement.angle.1,
                                                 ifelse(oppo.movement.angle.1 > 0 & (abs(a1)-abs(a2))<0,180+oppo.movement.angle.1,p.movement.angle.1)))
  
  
}
```
```{r}
#oppositions end[i] to start [i+1] movement angle
for (i in 2:nrow(fed16_df)) {
  a1 <- fed16_df$oppo.end.position.x[i]
  b1 <- fed16_df$oppo.end.position.y[i]
  a2 <- fed16_df$oppo.start.position.x[i+1]
  b2 <- fed16_df$oppo.start.position.y[i+1]
  
  oppo.movement.angle.2 <- atan(
  ((abs(a1)-abs(a2))/(abs(b1)-abs(b2)))* 180/pi) 
  
  fed16_df$oppo.movement.angle.2[i] = ifelse(oppo.movement.angle.2 < 0 & (abs(a1)-abs(a2))<0, 180+oppo.movement.angle.2,
                                          ifelse(oppo.movement.angle.2 < 0 & (abs(b1)-abs(b2))<0,360+oppo.movement.angle.2,
                                                 ifelse(oppo.movement.angle.2 > 0 & (abs(a1)-abs(a2))<0, 180+oppo.movement.angle.2,oppo.movement.angle.2)))
}
```


```{r}
#code for this chunk relatively unchanged
# replaced ballmark.x with projected.ballmark.x; speed1 replaced by speed.start

fed16_df <- fed16_df %>%
  mutate(speed.diff = NA) %>%
  mutate(oppo.hit.x = NA) %>%
  mutate(oppo.hit.y = NA) %>%
  mutate(oppo.hit.z = NA) %>%
  mutate(oppo.speed = NA) %>%
  mutate(oppo.projected.ballmark.x = NA) %>%
  mutate(oppo.projected.ballmark.y = NA) %>%
  mutate(speed.ratio = NA) 


for (i in 2:nrow(fed16_df)) {
  if(fed16_df$shot[i] != 1) {#so that only non-serves are affected

  fed16_df$speed.diff[i]=fed16_df$speed.start[i]-fed16_df$speed.start[i-1]
  #speed difference
  
  fed16_df$oppo.hit.x[i]=fed16_df$start.x[i-1]
  fed16_df$oppo.hit.y[i]=fed16_df$start.y[i-1]
  fed16_df$oppo.hit.z[i]=fed16_df$start.z[i-1]
  fed16_df$oppo.speed[i]=fed16_df$speed.start[i-1]
  fed16_df$oppo.projected.ballmark.x[i]=fed16_df$projected.ballmark.x[i-1]
  fed16_df$oppo.projected.ballmark.y[i]=fed16_df$projected.ballmark.y[i-1]
  #oppo hit
  
  }
}

fed16_df <- fed16_df %>%
  mutate(speed.ratio = speed.start/oppo.speed) %>% #speed ratio
  mutate(side.dist = 4.115 - abs(oppo.projected.ballmark.y)) %>% #distance of oppo.projected.ballmark from sideline
  mutate(base.dist = 11.89 - abs(oppo.projected.ballmark.x)) %>% #distance of oppo.projected.ballmark from baseline
  mutate(short.dist = min(side.dist, base.dist)) #shortest distance from any line


#Adding angles
fed16_df <- fed16_df %>%
  mutate(p.start.x = NA) %>%
  mutate(p.start.y = NA)

for (i in 3:nrow(fed16_df)) {
  if(fed16_df$impact.player[i] == fed16_df$impact.player[i-2] & fed16_df$shot[i] == fed16_df$shot[i-2] + 2) {
    fed16_df$p.start.x[i]=fed16_df$start.x[i-2]
    fed16_df$p.start.y[i]=fed16_df$start.y[i-2]
  }
}

#adding angle between fed.shot-opp.shot vector and opp.shot-opp.projected.ballmark vector
#doing it in one line because df doesn't want to add vectors
fed16_df <- fed16_df %>%
  mutate(o.angle = NA)
  
for (i in 1:nrow(fed16_df)) {
  x1 <- fed16_df$p.start.x[i]
  y1 <- fed16_df$p.start.y[i]
  x2 <- fed16_df$oppo.hit.x[i]
  y2 <- fed16_df$oppo.hit.y[i]
  x3 <- fed16_df$oppo.projected.ballmark.x[i]
  y3 <- fed16_df$oppo.projected.ballmark.y[i]
  
  o.angle <- acos(
  ((c(x1,y1)-c(x2,y2))/sqrt((x1-x2)^2+(y1-y2)^2)) %*%
    ((c(x2,y2)-c(x3,y3))/sqrt((x2-x3)^2+(y2-y3)^2))) * 180/pi
  
  fed16_df$o.angle[i] = ifelse(o.angle > 90, 180-o.angle, o.angle)
}

#Now adding the angle the player hits
fed16_df <- fed16_df %>%
  mutate(p.angle = NA)
  
for (i in 1:nrow(fed16_df)) {
  x1 <- fed16_df$oppo.hit.x[i]
  y1 <- fed16_df$oppo.hit.y[i]
  x2 <- fed16_df$start.x[i]
  y2 <- fed16_df$start.y[i]
  x3 <- fed16_df$projected.ballmark.x[i]
  y3 <- fed16_df$projected.ballmark.y[i]
  
  p.angle <- acos(
  ((c(x1,y1)-c(x2,y2))/sqrt((x1-x2)^2+(y1-y2)^2)) %*%
    ((c(x2,y2)-c(x3,y3))/sqrt((x2-x3)^2+(y2-y3)^2))) * 180/pi
  
  fed16_df$p.angle[i] = ifelse(p.angle > 90, 180-p.angle, p.angle)
}

fed16_df <- fed16_df %>%
  mutate(lag.p.angle = 0) %>%
  mutate(lag.speed.ratio = 0)

#Add p.angle and speed ratio of prior shot
for (i in 3:nrow(fed16_df)) {
  fed16_df$lag.p.angle[i] = ifelse(fed16_df$impact.player[i]==fed16_df$impact.player[i-2] & fed16_df$shot[i] >= 4, fed16_df$p.angle[i-2], 0)
  fed16_df$lag.speed.ratio[i] = ifelse(fed16_df$impact.player[i]==fed16_df$impact.player[i-2] & fed16_df$shot[i] >= 4, fed16_df$speed.ratio[i-2], 0)
}
```




```{r}
#remove opponents
fed_no.opp <- fed16_df %>% 
  dplyr::filter(impact.player == "FEDERER")

#federer only - remove serves
fed_only <- fed_no.opp %>%
  filter(hitpoint != "S") %>%
  dplyr::select(-serveid)


#First remove any errors for start, projected.ballmark, so that we are only looking at shots that we hit onto the other side
#To check: ggplot(fed_only, aes(projected.ballmark.x, projected.ballmark.y)) + geom_point()
fed_only <- fed_only %>%
  filter(oppo.hit.x >= 0) %>%
  filter(oppo.projected.ballmark.x <= 0) %>%
  filter(projected.ballmark.x >= 0)

#Adding shot number cumulative count (functions as time)
#check this for new data set .
fed_only <- fed_only %>%
  mutate(count = 1)

  for (i in 2:nrow(fed_only)) {
    if(fed_only$matchid[i]==fed_only$matchid[i-1]) {
      fed_only$count[i] = fed_only$count[i-1] + 1
    }
  }

  

#Adjusting to remove NAs and replace with 0s for modelling
fed_only$o.angle[is.na(fed_only$o.angle)] <- 0
```
```{r}
fed16_df <- fed16_df %>%
  mutate(oppo.start.server.x = ifelse(server != "FEDERER", start.server.x, 0)) 
```


```{r str}
#to view collums that have been truncated
str(fed16_df, list.len = ncol(fed16_df))

# str(longest_df, list.len = ncol(longest_df))


```




```{r}
##Plots of shot and ballmark co-ordinates, angles made by shots and speed measures
library(ggplot2)
#X Co-ordinate of shot
ggplot(fed_only, aes(x=start.x,winner)) + geom_smooth() + xlab("X Coordinate of Shot") + ylab("Proportion of Winners") + ggtitle("Winners By X Co-Ordinate")

#Opponents shot before
library(hexbin)
ggplot(fed_only, aes(x=oppo.hit.x,y=oppo.hit.y,z=winner)) + stat_summary_hex(fun = function(winner) sum(winner)) + xlab("X Coordinate of Oppo Shot") + ylab("Y Coordinate of Oppo Shot") + ggtitle("Count of Winners By Opponent's Shot Co-Ordinates")
### Get help transforming this to proportion in each bin instead of raw count

#Fed Shots on x-y plane
ggplot(fed_only, aes(x=start.x,y=start.y,z=winner)) + stat_summary_hex(fun = function(winner) sum(winner)) + xlab("X Coordinate") + ylab("Y Coordinate") + ggtitle("Winners By Shot Co-Ordinates")

#Fed Ballmark by winner in x-y plane
ggplot(fed_only, aes(x=projected.ballmark.x,y=projected.ballmark.y,z=winner)) + stat_summary_hex(fun = function(winner) sum(winner)) + xlab("X Coordinate") + ylab("Y Coordinate") + ggtitle("Winners By Shot Ballmark Co-Ordinates")


#Angle of shots
ggplot(fed_only, aes(x=o.angle,y=winner)) + geom_smooth() + xlab("Angle Made By Opponents Shot With Fed's Previous Shot") + ylab("Proportion of Winners") + ggtitle("Winners By Opponent Shot Angle")

ggplot(fed_only, aes(x=p.angle,y=winner)) + geom_smooth() + xlab("Angle Made By Federer's Shot") + ylab("Proportion of Winners") + ggtitle("Winners By Federer's Shot Angle")

ggplot(fed_only) + geom_density(aes(p.angle,group=factor(winner),color=factor(winner))) + ggtitle("Density of Winners by Fed Shot Angles")

ggplot(fed_only) + geom_density(aes(o.angle,group=factor(winner),color=factor(winner))) + ggtitle("Density of Winners by Opponent Shot Angles")

#Winners by oppo speed
ggplot(fed_only) + geom_density(aes(oppo.speed, group = factor(winner), color=factor(winner)))

ggplot(fed_only, aes(x=factor(winner),y=oppo.speed,fill=factor(winner))) + geom_boxplot() + ggtitle("Winner by Opponent Speed")

#Winners by speed ratio
ggplot(fed_only) + geom_density(aes(speed.ratio, group = factor(winner), color=factor(winner)))

ggplot(fed_only, aes(x=factor(winner),y=speed.ratio,fill=factor(winner))) + geom_boxplot() + ggtitle("Winner by Speed Ratio")
```
```{r}
# na.omit(fed16_df)
```
```{r Player/Ball Position rows }

#creating new rows so that every second row start and end player positions are switched
#Also creating new rows so that every second row in start.x,/start.y is projected ballmark
#this allows us to better plot player positions as well as track positions for animations

join_df <- transform(fed16_df, p.start.position.x=p.end.position.x, p.start.position.y=p.end.position.y, oppo.start.position.x=oppo.end.position.x, oppo.start.position.y=oppo.end.position.y, start.x=projected.ballmark.x, start.y=projected.ballmark.y)

fed_pos <- bind_rows(fed16_df, setNames(join_df, names(fed16_df))) %>% 
           arrange(rally.number, shot)

fed_pos <- fed_pos %>%
  group_by(rally.number, idx = cumsum(event == 1L)) %>%
  mutate(location.id= row_number()) %>%
  ungroup

fed_pos <- fed_pos %>%
  group_by(rally.number) %>%
  mutate(pos.rally.count= 1:n()) %>%
  ungroup
``` 

 
```{r rally variables}
#examining rallies to look at side to side movement within rallies. Starting with the longest rally.
longral_df <- filter(fed16_pos, final.shot >= 10)
```
```{r}
longest_df <- filter(fed16_pos, final.shot == 17)
```

```{r}
#speed ratio

ggplot(fed16_df, aes(x=base.dist,y=speed.ratio)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Speed Ratio") + ggtitle("Speed ratio by distance from the baseline For match")

ggplot(fed_only, aes(x=base.dist,y=speed.ratio)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Speed Ratio") + ggtitle("Fed Only Speed ratio by distance from the baseline For match")

ggplot(longral_df, aes(x=base.dist,y=speed.ratio)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Speed Ratio") + ggtitle("Speed ratio by distance from the baseline For Long Rallies")

ggplot(longest_df, aes(x=base.dist,y=speed.ratio)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Speed Ratio") + ggtitle("Speed ratio by distance from the baseline For Longest Rally")




#player shot angles

ggplot(fed16_df, aes(x=base.dist,y=p.angle)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Angle Made By Federers Shot") + ggtitle("Federer Shot Angle by distance from the baseline")

ggplot(fed_only, aes(x=base.dist,y=p.angle)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Angle Made By Federers Shot") + ggtitle("Fed only Shot Angle by distance from the baseline")

ggplot(fed16_df, aes(x=base.dist,y=o.angle)) + geom_smooth() + xlab("Distance from the baseline") + ylab("Angle Made By Berdych previous Shot") + ggtitle("Berdych Shot Angle by Federer distance from the baseline")


```

```{r Top down court view}

library(plotly)
#--- Packages Required
# require(ggplot2)
# require(plotly)

#--- Outline of the court
court_trace <- data.frame(x = c(-11.89, -11.89, 0, 0, 0, 11.89, 11.89, -11.89, -11.89, 11.89, 11.89, -11.89, -6.4, -6.4, 6.4, 6.4, 6.4, -6.4),
                          y = c(5.49, -5.49, -5.49, 5.49, -5.49, -5.49, 5.49, 5.49, 4.115, 4.115, -4.115, -4.115, -4.115, 4.115, 4.115, -4.115, 0, 0),
                          z = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0))
net_trace <- data.frame(x = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                        y = c(-5.49,-5.49, -6.4, -6.4, -5.49, 0, 5.49, 6.4, 6.4, 5.49, 5.49),
                        z = c(1.07, 0, 0, 1.07, 1.07, 0.914, 1.07, 1.07, 0, 0, 1.07))
service_trace <- data.frame(x = c(-8, 0, 0, 0, -6.4, -6.4, 0, -6.4, -6.4, -6.4, -6.4, -6.4,  0, 0, -8),
                            y = c(-5.49, -5.49, -4.115, 4.115, 4.115, 0, 0, 0, -4.115, -5.49, 5.49, -4.115, -4.115, 5.49, 5.49),
                            z = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ,0 ,0))
    
axis_labels <- data.frame(x.break = c(-21.89:-11.89, -6.4, 0, 6.4, 11.89),
                          x.label = c("-10m","","","","","-5m","","","","",
                                      "Baseline","Service Line","Net","Service Line","Baseline"),
                          y.break = c(-5.49,-4.115,0,4.115,5.49),
                          y.label = c("Doubles", "Singles","Centre","Singles","Doubles"),
                          z.break = c(0,0.992,2,3,4),
                          z.label = c("Ground", "Net", "2m", "3m", "4m"))
#--- Top down court view
court_topdown <- ggplot() + 
    labs(x = "x direction", y = "y direction") + 
    scale_x_continuous(breaks = axis_labels$x.break,
                       labels = axis_labels$x.label) +
    scale_y_continuous(breaks = axis_labels$y.break,
                       labels = axis_labels$y.label) +
    geom_path(data = court_trace, aes(x = x, y = y), color = 'black', size = 1, alpha = 0.75) +
    geom_path(data = net_trace, aes(x = x, y = y), color = 'grey40', size = 1, lineend = 'round') +
    coord_fixed()



  
```

```{r}
#--- Top Down Halfcourt view player side


```


```{r}
#creating new variables to get more information about player movement
#First step is to create intermediate variables for seperating rallies when including new data which includes aces and serve returns these are included with initial mutations
#Second step is to put a count on rallies so that we can create new variables that look at individual rallies 
#Need help with that
#create some sum of variables for change of court side shot player/opposition, rally total energy expenditure, this will be more difficult as serve and serve expenditure will be counted, change of shot f/b within rally

  
```
```{r}
#Creating new variables for player positions/angles/speeds
#started by reorienting server/reciever start/end positions to match reorientation of projected.ballmark

#New Variables Player Distance from baseline
#server.start.dist.from.base
#server.end.dist.from.base
#receiver.start.dist.from.base
#receiver.end.dist.from.base
```




```{r}
# The new variables that we have in this data set (Rallies)are
#passed.baseline, speed.at.baseline, reaction.time, distance.from.sideline, depth, is.ground.stroke, is.going.for.line, inside.out.forehand, down.line.winner, serve1.stretch, all.valid, scorer, 

#receiver.distance, server.distance, receiver.avg.speed, receiver.peak.speed, receiver.avg.acceleration, receiver.peak.acceleration, receiver.advantage, receiver.work, receiver.total.changes, start.receiver.x, end.receiver.x

#server.avg.speed, server.peak.speed, server.avg.acceleration, server.peak.acceleration, server.advantage, server.work, server.total.changes, start.server.x, end.server.x
```


```{r}
#Using Data visualisation to explore new variables
```
```{r}
#Angle of movement
ggplot(fed_only, aes(x=oppo.movement.angle.1,y=winner)) + geom_smooth() + xlab("Angle Made By Opponents movement") + ylab("Proportion of Winners") + ggtitle("Winners By Opponent movement angle 1")

ggplot(fed_only, aes(x=p.movement.angle.1,y=winner)) + geom_smooth() + xlab("Angle Made By Federer's movement") + ylab("Proportion of Winners") + ggtitle("Winners By Federer's movement angle 1")

ggplot(fed_only, aes(x=p.movement.angle.1,y=p.peak.speed)) + geom_smooth() + xlab("Angle Made By Federer's movement") + ylab("Federers Peak Speed") + ggtitle("Winners By Federer's movement angle 1")


```


```{r}
# #Movement and shot position seperated by forehand and backhand
# ggplot(longral_df, aes(x=p.start.position.x,y=p.start.position.y,z=winner))  + stat_summary_hex(fun = function(winner) sum(winner)) + facet_wrap(~factor(hitpoint)) + xlab("Player start Position X ") + ylab("Player start Position Y") + ggtitle("Federer winners by start position seperated by shot type for long rallies")
# 
# ggplot(longral_df, aes(x=p.end.position.x,y=p.end.position.y,z=winner))  + stat_summary_hex(fun = function(winner) sum(winner)) + facet_wrap(~factor(hitpoint)) + xlab("Player end Position X ") + ylab("Player end Position Y") + ggtitle("Federer winners by end position seperated by shot type for long rallies")
# 
# ggplot(longral_df, aes(x=p.start.position.x,y=p.start.position.y,z=is.good))  + stat_summary_hex(fun = function(is.good) sum(is.good)) + facet_wrap(~factor(hitpoint)) + xlab("Player start Position X ") + ylab("Player start Position Y") + ggtitle("Federer errors by start position seperated by shot type for long rallies")
# 
# ggplot(longral_df, aes(x=p.end.position.x,y=p.end.position.y,z=is.good))  + stat_summary_hex(fun = function(is.good) sum(is.good)) + facet_wrap(~factor(hitpoint)) + xlab("Player end Position X ") + ylab("Player end Position Y") + ggtitle("Federer errors by end position seperated by shot type for long rallies")
# 
# ggplot(longral_df, aes(x=p.start.position.x,y=p.start.position.y,z=time.to.net))  + stat_summary_hex(fun = function(time.to.net) sum(time.to.net)) + facet_wrap(~factor(hitpoint)) + xlab("Player start Position X ") + ylab("Player start Position Y") + ggtitle("Federer shot time to net by start position seperated by shot type for long rallies")
# 
# ggplot(longral_df, aes(x=p.end.position.x,y=p.end.position.y,z=time.to.net))  + stat_summary_hex(fun = function(time.to.net) sum(time.to.net)) + facet_wrap(~factor(hitpoint)) + xlab("Player end Position X ") + ylab("Player end Position Y") + ggtitle("Federer shot time to net by end position seperated by shot type for long rallies")

```
```{r}
# Federer backhands are played on the baseline the majority of the time. All errors and winners for Federer backhands in long rallies are starting on negative y side of court. Examine this further to see what type of backhands are being played to identify any risks. 
#For running backhand in long rallies, with a slower speed to net more errors appear to occur


```





```{r}
library(grid)

# ggplot(longest_df, aes(x=p.start.position.x, xend=p.end.position.x, y=p.start.position.y, yend=p.end.position.y, z=winner))   + stat_summary_hex(fun = function(winner) sum(winner)) + geom_segment(arrow = arrow(angle = 15,))  + xlab("Federer Position X ") + ylab("Federer Position Y") + ggtitle("Federer positions in longest rally") 

# ggplot(longest_df, aes(x=p.start.position.x, xend=p.end.position.x, y=p.start.position.y, yend=p.end.position.y, z=winner))   + 
#   stat_summary_hex(fun = function(winner) sum(winner)) + 
#   geom_text(aes(label=shot)) +
#   geom_path(arrow = arrow(angle = 15))  + 
#   xlab("Federer Position X ") + 
#   ylab("Federer Position Y") + 
#   ggtitle("Federer positions in longest rally") 
```

```{r static player positions}
trial_df <- filter(fed_pos, final.shot >= 14)

 p.rally.paths <- ggplot(trial_df, aes(x=p.start.position.x,  y=p.start.position.y))    + 
   scale_x_continuous(breaks = axis_labels$x.break) +
    scale_y_continuous(breaks = axis_labels$y.break) +
    geom_path(data = court_trace, aes(x = x, y = y), color = 'black', size = 1, alpha = 0.75) +
    geom_path(data = net_trace, aes(x = x, y = y), color = 'grey40', size = 1, lineend = 'round') +
    coord_fixed() +
   geom_point(aes(alpha = shot))  + 
   geom_path(  arrow = arrow(angle = 15)) + 
   facet_wrap(~rally.number) + 
   xlab("Federer Position X ") + 
   ylab("Federer Position Y") + 
   ggtitle("Federer start and end positions for rallies 14 shots or longer") 
 p.rally.paths <- ggplotly(p.rally.paths)
   
 p.rally.paths


```

```{r}
 
oppo.rally.paths <- ggplot(trial_df, aes(x=oppo.start.position.x,  y=oppo.start.position.y ))    + 
  scale_x_continuous(breaks = axis_labels$x.break) +
  scale_y_continuous(breaks = axis_labels$y.break) +
  geom_path(data = court_trace, aes(x = x, y = y), color = 'black', size = 1, alpha = 0.75) +
  geom_path(data = net_trace, aes(x = x, y = y), color = 'grey40', size = 1, lineend = 'round') +
  coord_fixed() +
  geom_point(aes(alpha = shot))  + 
  geom_path(  arrow = arrow(angle = 15)) +   
  facet_wrap(~rally.number) + xlab("Opponent Position X ") + ylab("Opponent Position Y") +
  ggtitle("Opponent start and end positions for for rallies 14 shots or longer")  
oppo.rally.paths <- ggplotly(oppo.rally.paths)
oppo.rally.paths
```
```{r}
library(gganimate)
library(tweenr)
library(transformr)
```


```{r player rally animation}


p.rally.anim <- ggplot(longest_df, aes(x=p.start.position.x, xend=p.end.position.x, y=p.start.position.y, yend=p.end.position.y)) + 
  geom_point() +
  xlab("Federer Position X ") + 
  ylab("Federer Position Y") + 
  ggtitle("Federer start and end positions animated for longest rally") +
  transition_states(location.id, transition_length = 2, state_length = 2) + 
  shadow_mark(size = 2, colour = 'grey') +
  transition_time(pos.rally.count) 
  

  
animate(p.rally.anim, duration = 30, fps = 10)
```









```{r}
# library(depmixS4)
# t2.mod1 <- depmix(list(winner ~ 1, speed.ratio ~ 1), transition = p.start.position.x , data = fed16_df, nstates = 2, family=list(multinomial("identity"),gaussian()))
# t2.fm1<- fit(t2.mod1)
# summary(t2.fm1)
``` 


```{r}
check_df <- filter(fed16_pos, rally.number == "9")
```

```{r}
longest_pos <- filter(fed_pos, final.shot == 17)
longral_pos <- filter(fed_pos, final.shot >= 10)
```

```{r}
p.rally.anim8 <- ggplot() + 
  scale_x_continuous(breaks = axis_labels$x.break) +
    scale_y_continuous(breaks = axis_labels$y.break) +
    geom_path(data = court_trace, aes(x = x, y = y), color = 'black', size = 1, alpha = 0.75) +
    geom_path(data = net_trace, aes(x = x, y = y), color = 'grey40', size = 1, lineend = 'round') +
    coord_fixed() +
  geom_point(data= longral_pos, aes(x=p.start.position.x, y=p.start.position.y,  group = rally.number, colour="red")) +
  geom_path(data= longral_pos, aes(x=p.start.position.x, y=p.start.position.y,  group = rally.number, alpha = shot)) +
  geom_point(data= longral_pos, aes(x=oppo.start.position.x, y=oppo.start.position.y,  group = rally.number, colour="blue")) +
  geom_path(data= longral_pos, aes(x=oppo.start.position.x, y=oppo.start.position.y,  group = rally.number, alpha = shot)) +
  geom_point(data= longral_pos, aes(x=start.x, y=start.y, group = rally.number, colour="green")) +
  transition_reveal(pos.rally.count) +
  facet_wrap(~rally.number ) +
  xlab("Player Position X ") + 
  ylab("Player Position Y") + 
  ggtitle("Animation for Federer 2016 rallies 10 shots or more")+
  scale_colour_manual(name = "", values=c("red","green","blue"), labels= c("Berdych","Ball","Federer"))

#had to reverse geom_point colour labels for some reason

animate(p.rally.anim8, duration = 30, fps = 10)
```
```{r}
seventythree.df <- filter(longral_pos, rally.number=="73")

```
```{r}
p.rally.anim9 <- ggplot() + 
  scale_x_continuous(breaks = axis_labels$x.break) +
    scale_y_continuous(breaks = axis_labels$y.break) +
    geom_path(data = court_trace, aes(x = x, y = y), color = 'black', size = 1, alpha = 0.75) +
    geom_path(data = net_trace, aes(x = x, y = y), color = 'grey40', size = 1, lineend = 'round') +
    coord_fixed() +
  geom_point(data= seventythree.df, aes(x=p.start.position.x, y=p.start.position.y,  group = rally.number, colour="red")) +
  geom_path(data= seventythree.df, aes(x=p.start.position.x, y=p.start.position.y,  group = rally.number, alpha = shot)) +
  geom_point(data= seventythree.df, aes(x=oppo.start.position.x, y=oppo.start.position.y,  group = rally.number, colour="blue")) +
  geom_path(data= seventythree.df, aes(x=oppo.start.position.x, y=oppo.start.position.y,  group = rally.number, alpha = shot)) +
  geom_point(data= seventythree.df, aes(x=start.x, y=start.y, group = rally.number, colour="green")) +
  transition_reveal(pos.rally.count) +
  xlab("Player Position X ") + 
  ylab("Player Position Y") + 
  ggtitle("Federer 2016 Longest Rally Animation")+
  scale_colour_manual(name = "", values=c("red","green","blue"), labels= c("Berdych","Ball","Federer"))

#had to reverse geom_point colour labels for some reason

animate(p.rally.anim9, duration = 30, fps = 10)
```


