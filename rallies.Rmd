---
title: "rallies"
author: "Pat Healy"
date: "17 November 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(devtools)
library(ggplot2)
library(tidyr)
library(dplyr)
library(tidyverse)
```
```{r}
load("data/rallies.RData")
library(readr)
```
Shaping data to recreate the variables used in ("Federer AO 2017.Rmd")'Federer vs Berych 2017' for the AO matches 'Djokovic v Chung 2016', 'Djokovic v Chung 2018', 'Federer v Berdych 2016', 'Federer v Berdych 2018', 'Makarova v Konta 2016','Makarova v Konta 2017','Strycova v Garcia 2016' 'Strycova v Garcia 2017', 'Siegemund v Jankovic 2016','Siegemund v Jankovic 2017', 'Goffin v Thiem 2016''Goffin v Thiem 2017'""

'Siegemund v Jankovic 2017' goes from set 3 to set 6?? 

#### Sorting the matches

```{r df}
djo16_df <- filter(rallies, year == 2016, h2h == "DJOKOVIC CHUNG" )
djo16_df <- arrange(djo16_df, matchid, set, game, point, shot)

djo18_df <- filter(rallies, year == 2018, h2h == "DJOKOVIC CHUNG" )
djo18_df <- arrange(djo18_df, matchid, set, game, point, shot)

fed16_df <- filter(rallies, year == 2016, h2h == "FEDERER BERDYCH" )
fed16_df <- arrange(fed16_df, matchid, set, game, point, shot)

fed17_df <- filter(rallies, year == 2017, h2h == "FEDERER BERDYCH" )
fed17_df <- arrange(fed17_df, matchid, set, game, point, shot)

fed18_df <- filter(rallies, year == 2018, h2h == "FEDERER BERDYCH" )
fed18_df <- arrange(fed18_df, matchid, set, game, point, shot)

mak16_df <- filter(rallies, year == 2016, h2h == "MAKAROVA KONTA" )
mak16_df <- arrange(mak16_df, matchid, set, game, point, shot)

mak17_df <- filter(rallies, year == 2017, h2h == "MAKAROVA KONTA" )
mak17_df <- arrange(mak17_df, matchid, set, game, point, shot)

stry16_df <- filter(rallies, year == 2016, h2h == "STRYCOVA GARCIA" )
stry16_df <- arrange(stry16_df, matchid, set, game, point, shot)

stry17_df <- filter(rallies, year == 2017, h2h == "STRYCOVA GARCIA" )
stry17_df <- arrange(stry17_df, matchid, set, game, point, shot)

sie16_df <- filter(rallies, year == 2016, h2h == "SIEGEMUND JANKOVIC" )
sie16_df <- arrange(sie16_df, matchid, set, game, point, shot)

sie17_df <- filter(rallies, year == 2017, h2h == "SIEGEMUND JANKOVIC" )
sie17_df <- arrange(sie17_df, matchid, set, game, point, shot)

thi16_df <- filter(rallies, year == 2016, h2h == "THIEM GOFFIN" )
thi16_df <- arrange(thi16_df, matchid, set, game, point, shot)

thi17_df <- filter(rallies, year == 2017, h2h == "THIEM GOFFIN" )
thi17_df <- arrange(thi17_df, matchid, set, game, point, shot)
```

Starting with fed16 to compare to fed17

Need to compare projected.ballmark.x and start.x stats before reorienting shots. Need to confirm change of terms between data sets first. (no end.x/end.y? )

```{r df}

#Reorienting Federer 2016 Shots
fed16_df <- fed16_df %>% rowwise %>%
  mutate(projected.ballmark.x = ifelse(impact.player == "FEDERER" & start.x >= 0, -projected.ballmark.x, projected.ballmark.x)) %>%
  mutate(projected.ballmark.y = ifelse(impact.player == "FEDERER" & start.x >= 0, -projected.ballmark.y, projected.ballmark.y)) %>%
  mutate(start.y = ifelse(impact.player == "FEDERER" & start.x >= 0, -start.y, start.y))%>%
  mutate(start.x = ifelse(impact.player == "FEDERER" & start.x >= 0, -start.x, start.x)) 

#Reorienting Berdych 2016 Shots
fed16_df <- fed16_df %>% rowwise %>%
  mutate(start.y = ifelse(impact.player != "FEDERER" & start.x <= 0, -start.y, start.y)) %>%
  mutate(projected.ballmark.x = ifelse(impact.player != "FEDERER" & start.x <= 0, -projected.ballmark.x, projected.ballmark.x)) %>%
  mutate(projected.ballmark.y = ifelse(impact.player != "FEDERER" & start.x <= 0, -projected.ballmark.y, projected.ballmark.y)) %>%
  mutate(start.x = ifelse(impact.player != "FEDERER" & start.x <= 0, -start.x, start.x))
```




#####Recreating variables from Federer AO 2017 for fed16. 
(some columns in rallies data have a different classification than in federer2017 data. Such as 'is.good' replaces 'ended.in.error')(With Aceswe also now cannot recreate retser, retser1 or retser2 )

```{r}
fed16_df <- fed16_df %>%
  mutate(lastshot = ifelse(shot == final.shot,1,0)) %>%
  mutate(isserver = ifelse(server == impact.player,1,0)) %>%
  mutate(fhand = ifelse(hitpoint == "F",1,0)) %>%
  mutate(opponent = ifelse(server == "FEDERER", receiver, server))

fed16_df <- fed16_df %>%
  mutate(winner = ifelse(is.good == TRUE & lastshot == 1,1,0)) %>%
  mutate(ser1 = ifelse(serve == 1 & serve_classification == 1,1,0)) %>%
  mutate(ser2 = ifelse(serve == 2 & serve_classification == 1,1,0)) 
  
for (i in 1:ncol(fed16_df)) {
  if(is.character(fed16_df[,i]) == TRUE) {
    fed16_df[,i] <- as.factor(fed16_df[,i])
  }
}
```
```{r}
#can no longer do score differentials
```

```{r}
#code for this chunk relatively unchanged
# replaced ballmark.x with projected.ballmark.x; speed1 replaced by speed.start

fed16_df <- fed16_df %>%
  mutate(speed.diff = NA) %>%
  mutate(oppo.hit.x = NA) %>%
  mutate(oppo.hit.y = NA) %>%
  mutate(oppo.hit.z = NA) %>%
  mutate(oppo.speed = NA) %>%
  mutate(oppo.projected.ballmark.x = NA) %>%
  mutate(oppo.projected.ballmark.y = NA) %>%
  mutate(speed.ratio = NA)

for (i in 2:nrow(fed16_df)) {
  if(fed16_df$shot[i] != 1) {#so that only non-serves are affected

  fed16_df$speed.diff[i]=fed16_df$speed.start[i]-fed16_df$speed.start[i-1]
  #speed difference
  
  fed16_df$oppo.hit.x[i]=fed16_df$start.x[i-1]
  fed16_df$oppo.hit.y[i]=fed16_df$start.y[i-1]
  fed16_df$oppo.hit.z[i]=fed16_df$start.z[i-1]
  fed16_df$oppo.speed[i]=fed16_df$speed.start[i-1]
  fed16_df$oppo.projected.ballmark.x[i]=fed16_df$projected.ballmark.x[i-1]
  fed16_df$oppo.projected.ballmark.y[i]=fed16_df$projected.ballmark.y[i-1]
  #oppo hit
  
  }
}

fed16_df <- fed16_df %>%
  mutate(speed.ratio = speed.start/oppo.speed) %>% #speed ratio
  mutate(side.dist = 4.115 - abs(oppo.projected.ballmark.y)) %>% #distance of oppo.projected.ballmark from sideline
  mutate(base.dist = 11.89 - abs(oppo.projected.ballmark.x)) %>% #distance of oppo.projected.ballmark from baseline
  mutate(short.dist = min(side.dist, base.dist)) #shortest distance from any line


#Adding angles
fed16_df <- fed16_df %>%
  mutate(p.start.x = NA) %>%
  mutate(p.start.y = NA)

for (i in 3:nrow(fed16_df)) {
  if(fed16_df$impact.player[i] == fed16_df$impact.player[i-2] & fed16_df$shot[i] == fed16_df$shot[i-2] + 2) {
    fed16_df$p.start.x[i]=fed16_df$start.x[i-2]
    fed16_df$p.start.y[i]=fed16_df$start.y[i-2]
  }
}

#adding angle between fed.shot-opp.shot vector and opp.shot-opp.projected.ballmark vector
#doing it in one line because df doesn't want to add vectors
fed16_df <- fed16_df %>%
  mutate(o.angle = NA)
  
for (i in 1:nrow(fed16_df)) {
  x1 <- fed16_df$p.start.x[i]
  y1 <- fed16_df$p.start.y[i]
  x2 <- fed16_df$oppo.hit.x[i]
  y2 <- fed16_df$oppo.hit.y[i]
  x3 <- fed16_df$oppo.projected.ballmark.x[i]
  y3 <- fed16_df$oppo.projected.ballmark.y[i]
  
  o.angle <- acos(
  ((c(x1,y1)-c(x2,y2))/sqrt((x1-x2)^2+(y1-y2)^2)) %*%
    ((c(x2,y2)-c(x3,y3))/sqrt((x2-x3)^2+(y2-y3)^2))) * 180/pi
  
  fed16_df$o.angle[i] = ifelse(o.angle > 90, 180-o.angle, o.angle)
}

#Now adding the angle the player hits
fed16_df <- fed16_df %>%
  mutate(p.angle = NA)
  
for (i in 1:nrow(fed16_df)) {
  x1 <- fed16_df$oppo.hit.x[i]
  y1 <- fed16_df$oppo.hit.y[i]
  x2 <- fed16_df$start.x[i]
  y2 <- fed16_df$start.y[i]
  x3 <- fed16_df$projected.ballmark.x[i]
  y3 <- fed16_df$projected.ballmark.y[i]
  
  p.angle <- acos(
  ((c(x1,y1)-c(x2,y2))/sqrt((x1-x2)^2+(y1-y2)^2)) %*%
    ((c(x2,y2)-c(x3,y3))/sqrt((x2-x3)^2+(y2-y3)^2))) * 180/pi
  
  fed16_df$p.angle[i] = ifelse(p.angle > 90, 180-p.angle, p.angle)
}

fed16_df <- fed16_df %>%
  mutate(lag.p.angle = 0) %>%
  mutate(lag.speed.ratio = 0)

#Add p.angle and speed ratio of prior shot
for (i in 3:nrow(fed16_df)) {
  fed16_df$lag.p.angle[i] = ifelse(fed16_df$impact.player[i]==fed16_df$impact.player[i-2] & fed16_df$shot[i] >= 4, fed16_df$p.angle[i-2], 0)
  fed16_df$lag.speed.ratio[i] = ifelse(fed16_df$impact.player[i]==fed16_df$impact.player[i-2] & fed16_df$shot[i] >= 4, fed16_df$speed.ratio[i-2], 0)
}
```
```{r}

```



 