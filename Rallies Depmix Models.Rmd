---
title: "Rallies Depmix Models"
author: "Pat Healy"
date: "30 January 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Run rallies.Rmd before reading fed16_only.csv
library(readr)
library(ggplot2)
fed16_only <-  read.csv(file = "data/fed16_only.csv")
```

#Stepwise function to find best variables for Depmix model
```{r}

#choosing variables of interest
fed16_dep <- fed16_only[, c("rally.number", "p.start.position.x", "p.start.position.y",     "oppo.start.position.x", "oppo.start.position.y", "p.work", "oppo.work", "avg.player.speed.ratio", "avg.player.acceleration.ratio", "lag.p.movement.angle.1", "p.start.x", "p.start.y", "lag.p.angle", "lag.speed.ratio", "rally.side.change.count.diff")]
```






```{r}
library(depmixS4)
library(purrr)
library(MmgraphR)

```


#Stepwise to find the first best variable for Depmix

```{r}

#run through all variables to find highest log lik
fcov1 <- lapply(fed16_dep[c("rally.number", "p.start.position.x", "p.start.position.y",     "oppo.start.position.x", "oppo.start.position.y", "p.work", "oppo.work", "avg.player.speed.ratio", "avg.player.acceleration.ratio", "lag.p.movement.angle.1", "p.start.x", "p.start.y", "lag.p.angle", "lag.speed.ratio", "rally.side.change.count.diff")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


```

# ```{r}
# test <- (unclass(fcov1[1:24]))
# ```
# 
# 
# ```{r}
# lapply(unclass(test), '[[', 1)
# ```

#Looking for any correlation between chosen variables greater than 50%
```{r}
corMat <- cor(fed16_dep)
corMat_df <- as.data.frame(apply(corMat, 2, function(x) ifelse (abs(x) >=0.5,x,"NA")))
#Removed some variables with significant correlation with other variables above 50%:
#p.end.position.x, p.end.position.y,oppo.end.position.x, oppo.end.position.y, p.rally.side.change.count,oppo.rally.side.change.count, p.advantage, p.distance, oppo.distance, fhand, p.advantage, rally.distance.run.ratio
```

```{r}
# cor.test(formula = ~ avg.player.speed.ratio + rally.distance.run.ratio,
#          data = fed16_only)


```


##single variable models using map function
```{r}
library(depmixS4)
fed16_dep %>%
  map(function(w)  fit((depmix(winner ~ 1, data = fed16_only, transition = ~ w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)) )
 
```



###First best variable is p.start.position.x
```{r}
#Running single variable model of p.start.position.x to look at coefficients

mod1 <- depmix(winner ~ 1, transition = ~ p.start.position.x, data = fed16_only, nstates = 2, family=multinomial("identity"))
fm1 <- fit(mod1)

summary(fm1)
```


```{r}
#Graphing fitted model states for first best variables

probs = posterior(fm1)

	layout(1:2)
	plot(probs$state, type='s', main='Implied States', xlab='', ylab='State')
	
	matplot(probs[,-1], type='l', main='Probabilities', ylab='Probability')
		legend(x='topright', c('State1','State2'),  fill=1:2, bty='n')
```


#Stepwise to find second best variable

```{r}
library(depmixS4)
lapply(fed16_dep[c("rally.number", "p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.work", "oppo.work", "avg.player.speed.ratio", "avg.player.acceleration.ratio", "lag.p.movement.angle.1", "p.start.x", "p.start.y", "lag.p.angle", "lag.speed.ratio", "rally.side.change.count.diff")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


```

#Stepwise to find the third best variable
```{r}
#second best variable is oppo.start.position.x
library(depmixS4)
lapply(fed16_dep[c("rally.number", "p.start.position.y", "oppo.start.position.y", "p.work", "oppo.work", "avg.player.speed.ratio", "avg.player.acceleration.ratio", "lag.p.movement.angle.1", "p.start.x", "p.start.y", "lag.p.angle", "lag.speed.ratio", "rally.side.change.count.diff")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))
```
#Stepwise to find the fourth best variable

```{r}
library(depmixS4)
#third best variable is avg.player.speed.ratio
lapply(fed16_dep[c("rally.number", "p.start.position.y", "oppo.start.position.y", "p.work", "oppo.work", "avg.player.speed.ratio", "lag.p.movement.angle.1", "p.start.x", "p.start.y", "lag.p.angle", "lag.speed.ratio", "rally.side.change.count.diff")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ ~ p.start.position.x + oppo.start.position.x + avg.player.speed.ratio + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))
```
#stepwise to find fifth best variable
```{r}
#fourth best variable is p.start.x

library(depmixS4)

lapply(fed16_dep[c("rally.number", "p.start.position.y", "oppo.start.position.y", "p.work", "oppo.work", "avg.player.speed.ratio", "lag.p.movement.angle.1", "p.start.y", "lag.p.angle", "lag.speed.ratio", "rally.side.change.count.diff")], 
       function(w) fit((depmix(winner ~ 1, data = fed16_only,transition = ~ p.start.position.x + oppo.start.position.x + avg.player.speed.ratio + p.start.x + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))
```



#stepwise to find sixth best variable
```{r}
#fifth best variable is oppo.movement.angle.2

library(depmixS4)

lapply(fed16_dep[c("rally.number",    "p.start.position.y",     "oppo.start.position.x", "oppo.start.position.y",      "p.work", "oppo.work",   "avg.player.speed.ratio", "avg.player.acceleration.ratio", "p.start.y",  "p.start.x", "p.start.y", "lag.speed.ratio")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + p.movement.angle.2 + oppo.distance + oppo.movement.angle.2 + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))

```















###Fitted Depmix model for 5 variables from single variable models
```{r}
#Five best single variables
#p.start.position.x, p.advantage, p.end.position.x, oppo.start.position.x, oppo.distance

mod2 <- depmix(winner ~ 1, transition = ~ p.start.position.x + p.advantage + p.end.position.x + oppo.start.position.x + oppo.distance, data = fed16_only, nstates = 2, family=multinomial("identity"))
fm2 <- fit(mod2)

summary(fm2)
```

###Fitted Depmix Model for the best five variable model
```{r}
#Five best stepwise variables
#p.start.position.x, oppo.start.position.x, p.start.y, oppo.distance, p.end.position.y

mod3 <- depmix(winner ~ 1, transition = ~ p.start.position.x + oppo.start.position.x + p.start.y + oppo.distance + p.end.position.y, data = fed16_only, nstates = 2, family=multinomial("identity"))
fm3 <- fit(mod3)

summary(fm3)
```

###Graphing fitted models of five best single variables and five best stepwise variables

```{r}
#Fitted states for five best single variables
probs = posterior(fm2)

	layout(1:2)
	plot(probs$state, type='s', main='Implied States', xlab='', ylab='State')
	
	matplot(probs[,-1], type='l', main='Probabilities', ylab='Probability')
		legend(x='topright', c('State1','State2'),  fill=1:2, bty='n')
```

```{r}
#Fitted states for best five variable model
#p.start.position.x, oppo.start.position.x, p.start.y, oppo.distance, p.end.position.y
probs = posterior(fm3)

	layout(1:3)
	plot(probs$state, type='s', main='Implied States', xlab='', ylab='State')
	
	matplot(probs[,-1], type='l', main='Probabilities', ylab='Probability')
		legend(x='topright', c('State1','State2'),  fill=1:2, bty='n')
		
	
```




#test loop for depmix




```{r}

#model to automate stepwise crashes becuase of correlation between variables
# recursive.factorial <- function(x) {
# if (x == 0)    return (1)
# else           return (x * recursive.factorial(x-1))
# }

# loop_data <- fed16_only[, c("winner","rally.number",   "p.start.position.x",    "p.start.position.y",     "oppo.start.position.x", "oppo.start.position.y",      "p.work", "oppo.work",   "avg.player.speed.ratio", "avg.player.acceleration.ratio",       "p.movement.angle.1", "p.movement.angle.2", "oppo.movement.angle.2", "p.start.x", "p.start.y", "lag.p.angle", "lag.speed.ratio")]
# 
# next_best_var <- function(data, column = NULL){
#   # if we know what variable to remove, remove it
#   if (!is.null(column)){
#     data <- data[, names(data) != column]
#   }
#   #if 1 variable remaining, add to model
#   if (ncol(data) == 1){
#     return(colnames(data))
#   }
#   #map over all available columns
#   
#   
#   
#   
#   
# }
# 
# inside_func <- function(data, x){
#   fm <- fit(depmix(winner ~ 1, data = data, transition = ~ x, nstates = 2, family=multinomial("identity")))
#   
#   
#   
#   }
# 
# # for every possible variable in data set
# Loop_trial <- ha %>% map(function(data,x) 
#   t6.mod41 <- depmix(winner ~ 1, data = fed16_only, transition = ~ x, nstates = 2, family=multinomial("identity")))
#  t6.fm41<- fit(t6.mod41)
#  
# 
#  t6.fm41
 
 
```
