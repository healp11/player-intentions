---
title: "Rallies Depmix Models"
author: "Pat Healy"
date: "30 January 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Run rallies.Rmd before reading fed16_only.csv
library(readr)
library(ggplot2)
fed16_only <-  read.csv(file = "data/fed16_only.csv")
```
#Training data fo Depmix Model Feder vs Berdych 2016
##Using stepwise to find best variables for Depmix model
```{r}
library(dplyr)

#choosing variables of interest
fed16_dep <- fed16_only[, c( "p.start.position.x", "p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")]




```


```{r}
#scaling variables from 0 min to 1 max for comparison to hidden states plot
fed16_scale <- fed16_only[, c(  "p.start.position.x", "p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")]

fed16_scale <- as.data.frame(lapply(fed16_dep[c( "p.start.position.x", "p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(x) (x-min(x))/(max(x)-min(x))))
#adding winner and total shot number to the df for analysis
fed16_scale <- cbind(fed16_scale, winner = fed16_only$winner)

fed16_scale <- fed16_scale %>% mutate(player.total.shot.number = row_number())
```

#Looking for any correlation between chosen variables greater than 50%
```{r}
#Creating correlation matrix for variables of interest. Variables under 50% correlation will show as NA
corMat <- cor(fed16_dep)
corMat_df <- as.data.frame(apply(corMat, 2, function(x) ifelse (abs(x) >=0.5,x,"NA")))
#Removed some variables with significant correlation with other variables above 50%:
#p.end.position.x, p.end.position.y, oppo.end.position.x, oppo.end.position.y, p.rally.side.change.count,oppo.rally.side.change.count, p.advantage, p.distance, oppo.distance, fhand, p.advantage, rally.distance.run.ratio, shot
```

```{r}

#check significance if any correlation found
    #cor.test(formula = ~  lag.oppo.height.off.net + S1,
             #data = fm1_df)


```




```{r}
library(depmixS4)
library(purrr)
library(MmgraphR)

```



#Glossary of chosen variables

"p.start.position.x": Numeric x location of player at the start of the shot.
"p.start.position.y": Numeric y location of player at the start of the shot.    
"oppo.start.position.x": Numeric x location of opponent at the start of the shot. 
"oppo.start.position.y": Numeric y location of opponent at the start of the shot.
: 
"p.diff.avg.shot.and.match.movement.speed": 
"p.movement.angle.1": 
"p.start.shot.x": Numerical x coordinate of the ball at the start of its arc for players shot.
"p.start.shot.y": Numerical y coordinate of the ball at the start of its arc for players shot.
"lag.p.angle": Angle made by players previous shot in rally.
"lag.speed.ratio": Speed ratio of players previous shot in rally.
"oppo.rally.side.change.count":
"lag.oppo.height.off.net"




#Fitted Depmix Model for the best stepwise variable model

```{r}
# Variables fitted:
#p.start.position.x, oppo.start.position.x, oppo.diff.avg.shot.and.match.movement.speed, p.diff.avg.shot.and.match.movement.speed, lag.p.angle, oppo.rally.side.change.count, lag.diff.oppo.avg.and.current.shot.speed, diff.p.avg.and.current.shot.speed, p.movement.angle.1, lag.oppo.height.off.net, oppo.start.position.y
 mod1 <- depmix(winner ~ 1, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + lag.diff.oppo.avg.and.current.shot.speed + diff.p.avg.and.current.shot.speed + p.movement.angle.1 + lag.oppo.height.off.net + oppo.start.position.y, data = fed16_scale, nstates = 2, family=multinomial("identity"))
 fm1 <- fit(mod1)
 
 summary(fm1)
```

```{r}
#Pulling state probabilities from fitted model to add to a dataframe to look for correlation with fitted variables
fm1_df <- posterior(fm1)

fm1_df <- cbind(fed16_scale, fm1_df)
	
#dropping columns not in the fitted depmix model

fm1_df <- fm1_df[ -c(2, 6, 14:15) ]
```




###Graphing fitted models of best stepwise variables



```{r}
#Plotting states for best thirteen variable model
#p.start.position.x, oppo.start.position.x, oppo.diff.avg.shot.and.match.movement.speed, p.diff.avg.shot.and.match.movement.speed, lag.p.angle, oppo.rally.side.change.count, lag.diff.oppo.avg.and.current.shot.speed, diff.p.avg.and.current.shot.speed, p.movement.angle.1, lag.oppo.height.off.net, oppo.start.position.y
probs = posterior(fm1)

	layout(1:2)
	plot(probs$state, type='s', main='Implied States', xlab='', ylab='State')
	
	matplot(probs[,-1], type='l', main='Probabilities', ylab='Probability')
		legend(x='topright', c('State1','State2'),  fill=1:2, bty='n')
		
	
```

```{r}
#plotting a matrix to identify any correlation between depmix probabilities and chosen variables
library(GGally)
ggduo(fm1_df, 1:3, 13, types = list(continuous = loess_with_cor), showStrips = FALSE)
ggduo(fm1_df, 4:6, 13, types = list(continuous = loess_with_cor), showStrips = FALSE)
ggduo(fm1_df, 7:9, 13, types = list(continuous = loess_with_cor), showStrips = FALSE)
ggduo(fm1_df, 10:11, 13, types = list(continuous = loess_with_cor), showStrips = FALSE)

# ggplot(fed16_scale, aes(x=p.start.position.x,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=oppo.start.position.x,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=oppo.diff.avg.shot.and.match.movement.speed,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=p.diff.avg.shot.and.match.movement.speed,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=lag.p.angle,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=oppo.rally.side.change.count,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=oppo.start.position.x,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=diff.p.avg.and.current.shot.speed,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=p.movement.angle.1,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=lag.oppo.height.off.net,y=S1)) + geom_point()
# ggplot(fed16_scale, aes(x=lag.diff.oppo.avg.and.current.shot.speed,y=S1)) + geom_point()

```

#Stepwise to find best variables for Depmix for Federer vs Berdych 2016
##Stepwise for first best variable

```{r}

#run through all variables to find highest log lik
fcov1 <- lapply(fed16_scale[c( "p.start.position.x", "p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov1_df <-  as.data.frame(
  c(logLik(fcov1$p.start.position.x), logLik(fcov1$p.start.position.y),
    logLik(fcov1$oppo.start.position.x), logLik(fcov1$oppo.start.position.y),
    logLik(fcov1$p.movement.angle.1),logLik(fcov1$p.start.shot.x),
    logLik(fcov1$lag.p.angle),
    logLik(fcov1$oppo.rally.side.change.count), logLik(fcov1$p.diff.avg.shot.and.match.movement.speed),
    logLik(fcov1$oppo.diff.avg.shot.and.match.movement.speed),
    logLik(fcov1$diff.p.avg.and.current.shot.speed),
    logLik(fcov1$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov1$lag.oppo.height.off.net)  )
  )

fcov1_df$newcolumn<-c( "p.start.position.x", "p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov1_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov1_df %>% 
   slice(which.max(convergence.loglik))

```




###First best variable is p.start.position.x
```{r}
#Running single variable model of p.start.position.x to look at coefficients

mod1 <- depmix(winner ~ 1, transition = ~ p.start.position.x, data = fed16_scale, nstates = 2, family=multinomial("identity"))
fm1 <- fit(mod1)

summary(fm1)


```



```{r}
#Graphing fitted model states for first best variable

probs = posterior(fm1)

	layout(1:2)
	plot(probs$state, type='s', main='Implied States', xlab='', ylab='State')
	
	matplot(probs[,-1], type='l', main='Probabilities', ylab='Probability')
		legend(x='topright', c('State1','State2'),  fill=1:2, bty='n')
```


##Stepwise to find second best variable

```{r}
fcov2 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov2_df <-  as.data.frame(
  c(logLik(fcov2$p.start.position.y),
    logLik(fcov2$oppo.start.position.x), logLik(fcov2$oppo.start.position.y),
    logLik(fcov2$p.movement.angle.1),logLik(fcov2$p.start.shot.x),
    logLik(fcov2$lag.p.angle),
    logLik(fcov2$oppo.rally.side.change.count), logLik(fcov2$p.diff.avg.shot.and.match.movement.speed),
    logLik(fcov2$oppo.diff.avg.shot.and.match.movement.speed),
    logLik(fcov2$diff.p.avg.and.current.shot.speed),
    logLik(fcov2$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov2$lag.oppo.height.off.net)  )
  )

fcov2_df$newcolumn<-c("p.start.position.y", "oppo.start.position.x", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov2_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov2_df %>% 
   slice(which.max(convergence.loglik))


```

##Stepwise to find the third best variable
```{r}
#second best variable is oppo.start.position.x
fcov3 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov3_df <-  as.data.frame(
  c(logLik(fcov3$p.start.position.y), logLik(fcov3$oppo.start.position.y),
    logLik(fcov3$p.movement.angle.1),logLik(fcov3$p.start.shot.x), 
    logLik(fcov3$lag.p.angle),
    logLik(fcov3$oppo.rally.side.change.count), logLik(fcov3$p.diff.avg.shot.and.match.movement.speed),
    logLik(fcov3$oppo.diff.avg.shot.and.match.movement.speed),
    logLik(fcov3$diff.p.avg.and.current.shot.speed),
    logLik(fcov3$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov3$lag.oppo.height.off.net)  )
  )

fcov3_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed",  "oppo.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov3_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov3_df %>% 
   slice(which.max(convergence.loglik))
```
##Stepwise to find the fourth best variable

```{r}
library(depmixS4)
#third best variable is oppo.diff.avg.shot.and.match.movement.speed


fcov4 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov4_df <-  as.data.frame(
  c(logLik(fcov4$p.start.position.y), logLik(fcov4$oppo.start.position.y),
    logLik(fcov4$p.movement.angle.1),logLik(fcov4$p.start.shot.x), 
    logLik(fcov4$lag.p.angle),
    logLik(fcov4$oppo.rally.side.change.count), logLik(fcov4$p.diff.avg.shot.and.match.movement.speed),
    logLik(fcov4$diff.p.avg.and.current.shot.speed),
    logLik(fcov4$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov4$lag.oppo.height.off.net)  )
  )

fcov4_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "p.diff.avg.shot.and.match.movement.speed", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov4_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov4_df %>% 
   slice(which.max(convergence.loglik))
```




##Stepwise to find fifth best variable
```{r}
#Fourth best variable is p.diff.avg.shot.and.match.movement.speed


fcov5 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov5_df <-  as.data.frame(
  c(logLik(fcov5$p.start.position.y), logLik(fcov5$oppo.start.position.y),
    logLik(fcov5$p.movement.angle.1),logLik(fcov5$p.start.shot.x), 
    logLik(fcov5$lag.p.angle),
    logLik(fcov5$oppo.rally.side.change.count),
    logLik(fcov5$diff.p.avg.and.current.shot.speed),
    logLik(fcov5$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov5$lag.oppo.height.off.net)  )
  )

fcov5_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.p.angle", "oppo.rally.side.change.count", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov5_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov5_df %>% 
   slice(which.max(convergence.loglik))
```
##Stepwise to find sixth best variable
```{r}
#fifth best variable is lag.p.angle
fcov6 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "oppo.rally.side.change.count", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov6_df <-  as.data.frame(
  c(logLik(fcov6$p.start.position.y), logLik(fcov6$oppo.start.position.y),
    logLik(fcov6$p.movement.angle.1),logLik(fcov6$p.start.shot.x),
    logLik(fcov6$oppo.rally.side.change.count),
    logLik(fcov6$diff.p.avg.and.current.shot.speed),
    logLik(fcov6$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov6$lag.oppo.height.off.net)  )
  )

fcov6_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "oppo.rally.side.change.count", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov6_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov6_df %>% 
   slice(which.max(convergence.loglik))
```


##Stepwise to find seventh best variable
```{r}
#sixth best variable is oppo.rally.side.change.count
fcov7 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x","diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov7_df <-  as.data.frame(
  c(logLik(fcov7$p.start.position.y), logLik(fcov7$oppo.start.position.y),
    logLik(fcov7$p.movement.angle.1),logLik(fcov7$p.start.shot.x),
    logLik(fcov7$diff.p.avg.and.current.shot.speed),
    logLik(fcov7$lag.diff.oppo.avg.and.current.shot.speed), logLik(fcov7$lag.oppo.height.off.net)  )
  )

fcov7_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "diff.p.avg.and.current.shot.speed", "lag.diff.oppo.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov7_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov7_df %>% 
   slice(which.max(convergence.loglik))



```





##Stepwise to find eighth best variable
```{r}
#seventh best variable is lag.diff.oppo.avg.and.current.shot.speed


fcov8 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x","diff.p.avg.and.current.shot.speed", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + lag.diff.oppo.avg.and.current.shot.speed + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov8_df <-  as.data.frame(
  c(logLik(fcov8$p.start.position.y), logLik(fcov8$oppo.start.position.y),
    logLik(fcov8$p.movement.angle.1),logLik(fcov8$p.start.shot.x),
    logLik(fcov8$diff.p.avg.and.current.shot.speed), logLik(fcov8$lag.oppo.height.off.net)  )
  )

fcov8_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "diff.p.avg.and.current.shot.speed", "lag.oppo.height.off.net")

names(fcov8_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov8_df %>% 
   slice(which.max(convergence.loglik))
```

##Stepwise to find ninth best variable
```{r}
#eigth best variable is diff.p.avg.and.current.shot.speed


fcov9 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + lag.diff.oppo.avg.and.current.shot.speed + diff.p.avg.and.current.shot.speed + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov9_df <-  as.data.frame(
  c(logLik(fcov9$p.start.position.y), logLik(fcov9$oppo.start.position.y),
    logLik(fcov9$p.movement.angle.1),logLik(fcov9$p.start.shot.x), logLik(fcov9$lag.oppo.height.off.net)  )
  )

fcov9_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.movement.angle.1", "p.start.shot.x", "lag.oppo.height.off.net")

names(fcov9_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov9_df %>% 
   slice(which.max(convergence.loglik))
```

##Stepwise to find tenth best variable
```{r}
#ninth best variable is p.movement.angle.1
fcov10 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y",  "p.start.shot.x", "lag.oppo.height.off.net")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + lag.diff.oppo.avg.and.current.shot.speed + diff.p.avg.and.current.shot.speed + p.movement.angle.1 + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov10_df <-  as.data.frame(
  c(logLik(fcov10$p.start.position.y), logLik(fcov10$oppo.start.position.y), logLik(fcov10$p.start.shot.x), logLik(fcov10$lag.oppo.height.off.net)  )
  )

fcov10_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.start.shot.x", "lag.oppo.height.off.net")

names(fcov10_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov10_df %>% 
   slice(which.max(convergence.loglik))
```
##Stepwise to find eleventh best variable
```{r}
#tenth best variable is lag.oppo.height.off.net


fcov11 <- lapply(fed16_scale[c("p.start.position.y", "oppo.start.position.y",  "p.start.shot.x")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + lag.diff.oppo.avg.and.current.shot.speed + diff.p.avg.and.current.shot.speed + p.movement.angle.1 + lag.oppo.height.off.net + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov11_df <-  as.data.frame(
  c(logLik(fcov11$p.start.position.y), logLik(fcov11$oppo.start.position.y), logLik(fcov11$p.start.shot.x)  )
  )

fcov11_df$newcolumn<-c("p.start.position.y", "oppo.start.position.y", "p.start.shot.x" )

names(fcov11_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov11_df %>% 
   slice(which.max(convergence.loglik))
```

##stepwise to find twelth best variable
```{r}
#eleventh best variable is oppo.start.position.y


fcov12 <- lapply(fed16_scale[c("p.start.position.y",  "p.start.shot.x")], function(w) fit((depmix(winner ~ 1, data = fed16_only, transition = ~ p.start.position.x + oppo.start.position.x + oppo.diff.avg.shot.and.match.movement.speed + p.diff.avg.shot.and.match.movement.speed + lag.p.angle + oppo.rally.side.change.count + lag.diff.oppo.avg.and.current.shot.speed + diff.p.avg.and.current.shot.speed + p.movement.angle.1 + lag.oppo.height.off.net + oppo.start.position.y + w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)))


#Pulling covergence log likelihoods into a dataframe
fcov12_df <-  as.data.frame(
  c(logLik(fcov12$p.start.position.y),  logLik(fcov12$p.start.shot.x)  )
  )

fcov12_df$newcolumn<-c("p.start.position.y", "p.start.shot.x" )

names(fcov12_df) <- c("convergence.loglik", "Variables")

#print variable with the highest convergence log likelihood
fcov12_df %>% 
   slice(which.max(convergence.loglik))

#final two variables do not improve model
```










###Intepreting the Model
Log Likelihood has decreased by apprximately 40%






###Visualising chosen variables to compare to hidden states model

```{r}

#question max in the game is note max  possible (ie 1 is a few metres back from the net)
	
attach(fed16_scale)
par(mfrow=c(2,1))

ggplot() + 
  geom_path(data=fed16_scale, aes(x = player.total.shot.number, y = p.start.position.x)) +
  xlab("Federer shot Number")  + 
  ylab(" Federer start position x coordinates for Federer shots") + 
  ggtitle("Federer 2016 start position x coordinates scaled") 
  

ggplot() + 
  geom_path(data=fed16_scale, aes(x = player.total.shot.number, y = oppo.start.position.x)) +
  xlab("Federer shot Number")  + 
  ylab(" Opponent start position x coordinates for Federer shots") + 
  ggtitle("Federer 2016 opponent start position x coordinates scaled") 
   
```

```{r}
library(tidyr)
fed16_plot1<- fed16_scale %>%
  gather(key = vars, value = measurement, p.start.position.x, oppo.start.position.x, oppo.rally.side.change.count)

fed16_plot2<- fed16_scale %>%
  gather(key = vars, value = measurement, p.start.shot.x, p.movement.angle.1, p.start.position.y, lag.p.angle)

fed16_plot3<- fed16_scale %>%
  gather(key = vars, value = measurement, oppo.start.position.y, p.start.shot.y)

ggplot(fed16_plot1, aes(x=player.total.shot.number,y=measurement)) + geom_line(color="blue") + facet_grid(vars~., scale="free_y") + xlab("Time") + ggtitle("Federer vs. Berdych 2016: Looking at how variables move together over the match")

ggplot(fed16_plot2, aes(x=player.total.shot.number,y=measurement)) + geom_line(color="blue") + facet_grid(vars~., scale="free_y") + xlab("Time") + ggtitle("Federer vs. Berdych 2016: Looking at how variables move together over the match")

ggplot(fed16_plot3, aes(x=player.total.shot.number,y=measurement)) + geom_line(color="blue") + facet_grid(vars~., scale="free_y") + xlab("Time") + ggtitle("Federer vs. Berdych 2016: Looking at how variables move together over the match")

```



#test loop for depmix


##single variable models using map function
```{r}
#for use with loop
# library(depmixS4)
# fed16_dep %>%
#   map(function(w)  fit((depmix(winner ~ 1, data = fed16_only, transition = ~ w, nstates = 2, family=multinomial("identity"))), verbose = FALSE, emc=em.control(rand=TRUE)) )
#  
```

```{r}

#model to automate stepwise crashes becuase of correlation between variables
# recursive.factorial <- function(x) {
# if (x == 0)    return (1)
# else           return (x * recursive.factorial(x-1))
# }

# loop_data <- fed16_only[, c("winner",   "p.start.position.x",    "p.start.position.y",     "oppo.start.position.x", "oppo.start.position.y",      "p.work", "oppo.work",    "p.diff.avg.shot.and.match.movement.speed",       "p.movement.angle.1", "p.movement.angle.2", "oppo.movement.angle.2", "p.start.shot.x", "p.start.shot.y", "lag.p.angle", "lag.speed.ratio")]
# 
# next_best_var <- function(data, column = NULL){
#   # if we know what variable to remove, remove it
#   if (!is.null(column)){
#     data <- data[, names(data) != column]
#   }
#   #if 1 variable remaining, add to model
#   if (ncol(data) == 1){
#     return(colnames(data))
#   }
#   #map over all available columns
#   
#   
#   
#   
#   
# }
# 
# inside_func <- function(data, x){
#   fm <- fit(depmix(winner ~ 1, data = data, transition = ~ x, nstates = 2, family=multinomial("identity")))
#   
#   
#   
#   }
# 
# # for every possible variable in data set
# Loop_trial <- ha %>% map(function(data,x) 
#   t6.mod41 <- depmix(winner ~ 1, data = fed16_only, transition = ~ x, nstates = 2, family=multinomial("identity")))
#  t6.fm41<- fit(t6.mod41)
#  
# 
#  t6.fm41
 
 
```




